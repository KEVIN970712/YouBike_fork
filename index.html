<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta name="google-site-verification" content="9o55RpXAKN7kR9cYHHvHkWuktV3JVcCYF5mt9XZULCY" />
    <meta charset="UTF-8" />
    <meta name="author" content="卓稟鈞(AndrewCho)">
    <meta name="description" content="一個專為 YouBike 設計的簡單、美觀且低流量站點搜尋器，提供快速查詢站點資訊功能，滿足即時需求，適合所有用戶使用。">
    <meta name="keywords" content="YouBike, youBike, YouBike2.0, youBike2.0, ubike, ibike, obike, kbike, 微笑單車，公共自行車, 腳踏車，YouBike站點搜尋, 站點搜尋, YouBike 資訊, YouBike據點，ubike據點 ，附近站點, 附近YouBike站點, 全台YouBike, 台北YouBike, 新北YouBike, 桃園YouBike, 新竹YouBike, 苗栗YouBike, 臺中YouBike, 嘉義YouBike , 臺南YouBike, 高雄YouBike, 屏東YouBike, 臺東YouBike , YouBike即時資訊, 定位功能, Github, github.io" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouBike 站點搜尋 : 一個簡單、美觀、低流量的YouBike站點搜尋器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="/YouBike/manifest.json" />
    <link rel="icon" type="image/x-icon" href="https://potatosserver.github.io/YouBike/icons/icon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
      body {
        font-family: 'Noto Sans TC', Arial, sans-serif;
        margin: 0; /* 移除預設 body 邊距 */
        background: #f4f4f4; /* 預設亮色模式背景 */
        color: #333; /* 預設亮色模式文字顏色 */
        transition: background 0.5s ease, color 0.5s ease;
        padding-top: 20px; /* 增加頂部填充 */
      }

      #locationNotification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: rgba(255, 193, 7, 0.9);
        color: #000;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10001;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      #locationNotification.show {
        opacity: 1;
        transform: translateY(0);
      }

      #locationNotification.hide {
        opacity: 0;
        transform: translateY(-20px);
      }
      /* 主標題專用樣式，避免被其他 h1 樣式覆蓋 */
      .main-title {
        color: #007bff;
        text-align: center;
        margin-bottom: 8px; /* 從 12px 改為 8px */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        padding: 4px; /* 從 6px 改為 4px */
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        display: inline-block;
        font-size: 1.4em; /* 加入字體大小縮小 */
      }
      body.dark-mode .main-title {
        color: #90CAF9;
      }
      /* Material 3 風格的搜尋欄容器 */
      #searchContainer {
        display: flex;
        align-items: center;
        margin-left: auto;
        margin-right: auto;
        max-width: 500px;
        width: calc(100% - 40px); /* Adjust width for padding */
        position: relative;
        padding: 8px 16px; /* Adjusted internal padding */
        box-sizing: border-box; /* Ensure padding doesn't increase total width */
        background-color: white; /* Default background */
        border-radius: 28px; /* Large rounded corners */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* subtle elevation */
        transition: box-shadow 0.3s ease;
      }

      body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* Dark mode background */
          box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1); /* Dark mode subtle elevation */
      }

      /* Material 3 風格的搜尋輸入框 */
      #keyword {
        padding: 0; /* Remove input's own padding, controlled by container */
        width: calc(100% - 34px); /* Adjust width to leave space for icon and spacing */
        border: none; /* Remove border */
        border-radius: 0; /* Rounded corners controlled by container */
        margin: 0; /* Remove margin */
        font-size: 16px;
        box-shadow: none; /* Shadow controlled by container */
        word-wrap: break-word;
        overflow-wrap: break-word;
        display: block;
        background-color: transparent; /* Transparent background to show container background */
        color: #333; /* Default text color */
      }

      body.dark-mode #keyword {
          color: #ffffff; /* Dark mode text color */
      }

      #keyword::placeholder {
        color: #888; /* Placeholder text color */
      }
      #keyword:focus {
        outline: none; /* Remove default focus outline */
        /* Add Material 3 style focus effect here if needed */
      }

      /* Search icon style (Material Icons) */
      #searchIcon {
        position: static; /* Let icon flow naturally in flex layout */
        margin-left: 10px; /* Spacing between input and icon */
        font-size: 24px; /* Material Icons default size */
        cursor: pointer;
        color: #555; /* Default icon color */
        transition: color 0.3s ease;
        flex-shrink: 0; /* Prevent icon from shrinking */
        display: inline-flex; /* Use flex to center icon */
        align-items: center;
        justify-content: center;
        width: 24px; /* Set width */
        height: 24px; /* Set height */
      }

      body.dark-mode #searchIcon {
          color: #ccc; /* Dark mode icon color */
      }

      #searchIcon:hover {
        color: #007BFF; /* Hover color */
      }

      /* Adjust spacing below the search container */
      #searchContainer + #locationSwitchContainer {
           margin-top: 6px; /* 從 10px 改為 6px */
      }

      #locationSwitchContainer {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
      }

      body.dark-mode #locationSwitchContainer {
          background-color: rgba(30, 30, 30, 0.9);
          box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
      }

      #locationSwitchText {
          color: #007BFF;
          font-weight: 500;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
          margin-left: 10px;
      }

      body.dark-mode #locationSwitchText {
          color: #90CAF9;
          text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      }

      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        padding: 0 20px; /* Add padding to results container */
      }
      .station {
        background-color: white;
        border: 1px solid #e0e0e0;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: calc(33% - 20px);
        min-width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
        cursor: pointer;
        position: relative;
      }
      .station:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
      .station h3 {
        margin: 0 0 10px 0;
        color: #007BFF;
        font-size: 1.2em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding-right: 30px;
      }
      .station p {
        margin: 0 0 5px 0;
        color: #555;
        font-size: 1em;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .station .pin-button {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #007BFF;
        transition: transform 0.2s ease, color 0.2s ease;
        user-select: none;
      }
      .station .pin-button:hover {
        transform: scale(1.2);
        color: #0056b3;
      }
      .station .pin-button.pinned {
        color: #FFD700;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 1.2em;
        z-index: 10;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
        white-space: nowrap;
        width: auto;
      }
      #loading.show {
        opacity: 1;
        display: block;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .overlay.show {
        display: block;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        display: none;
      }
      .modal.show {
        display: block;
      }
      .modal button {
        margin: 10px auto;
        display: block;
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .modal button:hover {
        background-color: #0056b3;
      }
      /* Dark mode styles */
      body.dark-mode {
        background: #333;
        color: #ffffff;
        transition: background 0.5s ease, color 0.5s ease;
      }
      body.dark-mode h1 {
        color: #90CAF9; /* 與暗色模式站點名稱一致 */
      }
      body.dark-mode #keyword {
        /* 在暗色模式下，關鍵字背景應透明以顯示搜尋容器背景 */
        background-color: transparent;
        color: #ffffff;
        border-color: #90caf9; /* 此邊框顏色不會顯示，因為 border: none */
      }
      body.dark-mode #keyword::placeholder {
         color: #888; /* 調整暗色模式下佔位符顏色 */
      }

       body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* 暗色模式容器背景 */
          box-shadow: 0 2px 4px rgba(255,255,255,0.1); /* 暗色模式細微陰影 */
      }
       body.dark-mode #searchIcon {
          color: #ccc; /* 暗色模式圖標顏色 */
      }
      body.dark-mode #searchIcon:hover {
        color: #ffffff; /* 暗色模式下懸停時為白色圖標 */
      }
      body.dark-mode button {
        background-color: #90caf9;
        color: #121212;
      }
      body.dark-mode button:hover {
        background-color: #64b5f6;
      }
      body.dark-mode .station {
        background-color: #444;
        border-color: #555;
        color: #ffffff;
      }
      body.dark-mode .station h3 {
        color: #90CAF9;
      }
      body.dark-mode .station p {
        color: #cccccc;
      }
      body.dark-mode .modal {
        background-color: #333;
        color: #ffffff;
      }
      body.dark-mode .overlay {
        background-color: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode #loading {
        background: #ffffff;
        color: #000000;
      }      body.dark-mode #loadingOverlay {
        background-color: rgba(51, 51, 51, 1);
      }
      body.dark-mode #loadingText {
        color: #ffffff;
      }
      body.dark-mode #noticeBox {
        background-color: #000;
        color: #000;
        border: 1px solid #444;
      }
      #toggleDarkMode {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #007BFF, #0056b3);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: background 0.3s ease, transform 0.2s ease;
      }
      #toggleDarkMode:hover {
        background: linear-gradient(135deg, #0056b3, #003f7f);
        transform: scale(1.1);
      }
      body.dark-mode #toggleDarkMode {
        background: linear-gradient(135deg, #90caf9, #64b5f6);
        color: #121212;
      }
      body.dark-mode #toggleDarkMode:hover {
        background: linear-gradient(135deg, #64b5f6, #42a5f5);
      }
      /* 新增地圖與浮動卡片樣式 */
      #map {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
        touch-action: none; /* 防止預設觸控行為 */
      }
      #floatingCard {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 600px;
        background: rgba(255,255,255,0.95);
        border: 1px solid #ccc;
        border-radius: 10px 10px 0 0;
        padding: 15px;
        box-shadow: 0 -2px 6px rgba(0,0,0,0.3);
        display: none;
        z-index: 2000;
      }
      #floatingCard h4 {
        margin: 0 0 8px 0;
      }      #mainContent {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        height: 40vh;
        min-height: 200px;
        max-height: 85vh;
        z-index: 2;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        padding-top: 0; /* 移除上方 padding */
        overflow-y: auto;
        width: 85%; /* 從 94% 改為 85% */
        max-width: 1000px; /* 從 1200px 改為 1000px */
        margin: 0 auto;
        left: 50%;
        transform: translateX(-50%);
        touch-action: pan-y; /* 修改：允許垂直捲動 */
        -webkit-overflow-scrolling: touch; /* 增加：提供 iOS 的平滑捲動 */
      }

      #mainContent::before {
        content: '';
        display: block;
        height: 24px; /* 設定頂部空間高度 */
        background: inherit; /* 繼承父元素背景色 */
        position: sticky;
        top: 0;
        z-index: 99;
      }

      #mainContent::-webkit-scrollbar {
        display: none;  /* Chrome, Safari and Opera */
      }

      body.dark-mode #mainContent {
        background: #222;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
      }

      /* 拖曳手柄樣式 */
      #dragHandle {
        position: sticky;
        top: 8px; /* 調整橫條在頂部空間中的位置 */
        z-index: 100;
        height: 20px; /* 增加可點擊區域 */
        cursor: ns-resize;
        background: transparent;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: -10px 0; /* 負邊距讓實際高度不影響布局 */
      }

      #dragHandle::before {
        content: '';
        width: 40px;
        height: 4px;
        background: #ccc;
        border-radius: 2px;
      }

      body.dark-mode #dragHandle::before {
        background: #666;
      }

      @media (max-width: 768px) {
        #mainContent {
          width: 80%; /* 從 92% 改為 80% */
        }
      }

      @media (max-width: 480px) {
        #mainContent {
          width: 100%;
          padding: 0; /* 移除上下 padding */
          max-width: none;
        }
        /* 移除 results 的左右 padding */
        #results {
          padding: 0 16px; /* 改為固定的左右 padding */
        }
        /* 移除 station 卡片的左右邊距 */
        .station {
          margin: 10px 0; /* 只保留上下邊距 */
          width: calc(100% - 32px); /* 配合 results 的 padding */
          border-radius: 10px; /* 保持圓角 */
        }
      }      /* Adjustments for narrow screens */
      @media (max-width: 768px) {
        .station {
          width: calc(50% - 20px);
        }
        /* Adjusted search container for horizontal layout */
        #searchContainer {
            /* Removed flex-direction: column; to keep items in a row */
            padding: 8px 12px; /* Adjust padding */
            /* Ensure display: flex and align-items: center; are effective */
        }
        #keyword {
          /* Adjusted width to leave space for the icon */
          width: calc(100% - 34px); /* Assuming 24px icon + 10px margin */
          margin-right: 0;
          margin-bottom: 0; /* No margin-bottom in row layout */
          border-radius: 28px; /* Keep rounded corners like default */
          display: block;
          padding: 0 12px; /* Padding controlled by container */
        }
         #searchIcon {
             position: static; /* Remain in static flow within flex container */
             margin-left: 10px; /* Space between input and icon */
             margin-top: 0; /* No margin-top in row layout */
             align-self: auto; /* Default alignment in flex row */
             /* Ensure font-size, width, height are set for the icon */
             font-size: 24px; /* Material Icons size */
             width: 24px;
             height: 24px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }

        button {
          width: 100%;
          border-radius: 0 0 5px 5px;
          display: block;
        }

        #results {
          gap: 10px;
        }
        .station {
          margin-bottom: 10px;
        }
      }
      @media (max-width: 480px) {
        .station {
          width: 100%;
        }
        #searchContainer {
             padding: 10px; /* Smaller screen spacing */
         }
         #keyword {
             /* Adjusted width for smaller screens if needed, keeping room for icon */
             width: calc(100% - 34px); /* Assuming 24px icon + 10px margin */
             padding: 0 10px; /* Padding controlled by container */
         }
         #results {
        /* 新增左右內邊距 */
        padding-left: 16px;
        padding-right: 16px;
    }
    .station {
        /* 為區塊加入左右間距，保持 100% 寬度時左右仍有間隙 */
        margin-left: 8px;
        margin-right: 8px;
    }
      }      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 1);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        transition: opacity 0.5s ease;
      }
      
      /* 新增通知樣式 */
      #locationNotification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: rgba(255, 193, 7, 0.9);
        color: #000;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10001;
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      #locationNotification.show {
        opacity: 1;
        transform: translateY(0);
      }

      #locationNotification.hide {
        opacity: 0;
        transform: translateY(-20px);
      }

      #loadingContent {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #loadingText {
        font-size: 1.5em;
        color: #007BFF;
        text-align: center;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #007BFF;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      /* Removed installButton styles */
      /* #installButton { ... } */
      /* #installButton img { ... } */      @keyframes popUp {
          0% { transform: translateX(100%) scale(0.5); opacity: 0; }
          100% { transform: translateX(0) scale(1); opacity: 1; }
      }
      @keyframes popDown {
          0% { transform: translateX(0) scale(1); opacity: 1; }
          100% { transform: translateX(100%) scale(0.5); opacity: 0; }
      }      #extraButtons {
          position: fixed;
          bottom: 120px;
          right: 80px;
          transform: translateX(150%);
          transition: transform 0.5s ease, opacity 0.5s ease;
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
      }      #extraButtons.show {
          transform: translateX(0);
          opacity: 1;
          pointer-events: auto;
          animation: popUp 0.5s forwards;
      }
      #extraButtons.hiding {
          animation: popDown 0.5s forwards;
      }
      #extraButtons a {
          width: 50px;
          height: 50px;
          background-color: white;
          color: black;
          border: none;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          text-decoration: none;
          transition: background-color 0.3s ease;
      }
      #extraButtons a:hover {
          background-color: #f0f0f0;
      }      #settingsPanel {
          position: fixed;
          bottom: 60px;
          right: 80px;
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1200;
          transform: translateX(100%) scale(0.5);
          opacity: 0;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.9);
          padding: 10px;
          border-radius: 30px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          backdrop-filter: blur(10px);
          pointer-events: none;
      }
      
      #settingsPanel.show {
          transform: translateX(0) scale(1);
          opacity: 1;
          pointer-events: auto;
      }
      
      body.dark-mode #settingsPanel {
          background: rgba(30, 30, 30, 0.9);
      }
      
      #settingsPanel.show {
          transform: translateX(0) scale(1);
          opacity: 1;
          animation: popUpSettings 0.3s forwards;
      }
      
      #darkModeToggle {
          display: none; /* 隱藏這個按鈕 */
      }
      
      #settingsPanel a,
      #settingsPanel button {
          transition: all 0.3s ease;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      
      #settingsPanel a:hover,
      #settingsPanel button:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      }

      /* Settings Panel Animations */
      @keyframes popUpSettings {
          0% { 
              transform: translateX(100%) scale(0.5);
              opacity: 0;
          }
          100% { 
              transform: translateX(0) scale(1);
              opacity: 1;
          }
      }

      @keyframes popDownSettings {
          0% { 
              transform: translateX(0) scale(1);
              opacity: 1;
          }
          100% { 
              transform: translateX(100%) scale(0.5);
              opacity: 0;
          }
      }

      #settingsPanel.hiding {
          animation: popDownSettings 0.3s forwards;
      }
      #updateCountdown {
        white-space: nowrap;
      }

      #mapControls {
        position: fixed;
        top: 8px;
        left: 50%;
        transform: translateX(-50%); /* 使用 transform 來置中 */
        z-index: 9000 !important;
        width: 90%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px; /* 從 6px 改為 4px */
        pointer-events: none; /* 允許點擊穿透到地圖 */
      }

      #mapControls > * {
        pointer-events: auto; /* 恢復控制項的點擊功能 */
      }

      #mapControls h1 {
        color: #007BFF;
        background-color: transparent;
        display: inline;
        padding: 0;
      }

      body.dark-mode #mapControls h1 {
        color: #90CAF9;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
      }

      /* 修改：僅當 body 有 dark-mode 類別時，將濾鏡套用於地圖層與控制項 */
      body.dark-mode .leaflet-layer,
      body.dark-mode .leaflet-control-zoom-in,
      body.dark-mode .leaflet-control-zoom-out,
      body.dark-mode .leaflet-control-attribution {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
      }

      /* 強制 popup 在所有搜尋框內容之上 */
      .leaflet-popup-pane {
        z-index: 12000 !important;
      }
      #mapControls, #mapControls * {
        z-index: 9000 !important;
        pointer-events: none !important;
      }
      #mapControls input,
      #mapControls button,
      #mapControls label,
      #mapControls .slider,
      #mapControls #searchIcon {
        pointer-events: auto !important;
      }

      /* 新增中央設定面板樣式 */
      #centralSettingsPanel {
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80%;
          max-width: 320px;
          background: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          padding: 25px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
          z-index: 10000;
          backdrop-filter: blur(10px);
          animation: fadeIn 0.3s ease;
          max-height: calc(100vh - 80px); /* 增加與上下邊界間距 */
          overflow-y: scroll; /* 允許內容捲動 */
          scrollbar-width: none; /* Firefox 隱藏捲軸 */
      }

      body.dark-mode #centralSettingsPanel {
          background: rgba(30, 30, 30, 0.95);
          color: #fff;
      }

      #centralSettingsPanel h2 {
          text-align: center;
          margin-bottom: 20px;
          color: #007BFF;
          font-size: 1.5em;
      }

      body.dark-mode #centralSettingsPanel h2 {
          color: #90CAF9;
      }

      .settings-group {
          margin-bottom: 20px;
          padding: 15px;
          background: transparent;
          border: 1px solid #000; /* 明亮模式：黑色外框 */
          border-radius: 10px;
          color: #333; /* 新增：明確設定文字顏色 */
          transition: border-color 0.3s; /* 只對邊框保留過渡效果 */
      }
      body.dark-mode .settings-group {
          border-color: #fff; /* 黑暗模式：白色外框 */
          color: #fff; /* 新增：明確設定深色模式文字顏色 */
      }

      .settings-group h3 {
          margin-bottom: 15px;
          color: #333;
          font-size: 1.2em;
          transition: none; /* 移除過渡效果 */
      }

      body.dark-mode .settings-group h3 {
          color: #fff;
      }

      .setting-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 15px;
          padding: 10px;
          background: #f0f0f0;
          border-radius: 8px;
          color: #333; /* 新增：明確設定文字顏色 */
          transition: background-color 0.3s; /* 只對背景保留過渡效果 */
      }

      body.dark-mode .setting-item {
          background: #455a64;
          color: #fff; /* 新增：明確設定深色模式文字顏色 */
      }

      /* Styles for external links in central settings panel */
      #centralSettingsPanel .github-link {
          color: #007BFF; /* Light blue for light mode */
          text-decoration: none; /* Remove underline */
          display: flex; /* Use flexbox for alignment */
          align-items: center; /* Vertically align items */
          width: 100%; /* Take full width of parent */
      }

      body.dark-mode #centralSettingsPanel .github-link {
          color: #90CAF9; /* Light blue for dark mode */
      }

      #centralSettingsPanel .github-link:visited {
          color: #007BFF; /* Keep same color after visited in light mode */
      }

      body.dark-mode #centralSettingsPanel .github-link:visited {
          color: #90CAF9; /* Keep same color after visited in dark mode */
      }

      #centralSettingsPanel .github-link:hover {
          color: #0056b3; /* Slightly darker blue on hover in light mode */
      }

      body.dark-mode #centralSettingsPanel .github-link:hover {
          color: #BBDEFB; /* Slightly lighter blue on hover in dark mode */
      }

      #centralSettingsPanel .github-link span {
          margin-left: 10px; /* Add some spacing between image and text */
      }


      #closeCentralSettings {
          position: absolute;
          top: 2vh;   /* 增加上間距 */
          right: 2vh; /* 增加右間距 */
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #666;
          padding: 8px;  /* 增加內間距 */
          border-radius: 50%;  /* 新增圓形邊框 */
          width: 40px;   /* 固定寬度 */
          height: 40px;  /* 固定高度 */
          display: flex;  /* 使用 flex 置中 */
          align-items: center;
          justify-content: center;
          transition: background-color 0.3s;  /* 新增過渡效果 */
      }

      #closeCentralSettings:hover {
          background-color: rgba(0, 0, 0, 0.1);  /* 新增懸停效果 */
      }

      body.dark-mode #closeCentralSettings {
          color: #fff;
      }

      body.dark-mode #closeCentralSettings:hover {
          background-color: rgba(255, 255, 255, 0.1);  /* 暗色模式懸停效果 */
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translate(-50%, -48%); }
          to { opacity: 1; transform: translate(-50%, -50%); }
      }

      /* 新增地區選擇下拉選單的深色模式樣式 */
      body.dark-mode #centralRegionSelect {
          background-color: #555; /* 深色背景 */
          color: #fff; /* 白色文字 */
          border: 1px solid #777; /* 深色邊框 */
      }

      body.dark-mode #centralRegionSelect option {
          background-color: #555; /* 深色背景 */
          color: #fff; /* 白色文字 */
      }

      /* 添加淡入動畫樣式 */
      #mainContent {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }

      #mainContent.fade-in {
        opacity: 1;
      }

      #loadingOverlay {
        opacity: 1;
        transition: opacity 0.5s ease-in-out;
      }

      #loadingOverlay.fade-out {
        opacity: 0;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="mapControls">
      <h1 id="heading" class="main-title"></h1>
      </div>
    <div id="locationNotification"></div>
    <div id="loadingOverlay">
      <div id="loadingContent">
        <h2 id="loadingText">載入中</h2>
        <div id="noticeBox" style="margin-top: 10px; margin-left: 20px; margin-right: 20px; background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></div>
      </div>
    </div>
    <div id="mainContent">
      <div id="dragHandle"></div>
      <div id="searchContainer">
        <input type="text" id="keyword" placeholder="請輸入站點名稱、地址" value="" />
        <span id="searchIcon" class="material-icons" title="搜尋">search</span>
        <span id="clearTextBtn" class="material-icons" title="清除" style="display:none; margin-left:10px; cursor:pointer;">close</span>
      </div>
      <div id="results"></div>
      <div id="loading">載入中，請稍候...</div>
      <div class="overlay"></div>
      <div class="modal" id="permissionModal">
        <p id="modalText"></p>
        <button id="modalButton">確定</button>
      </div>
      </div>      <button id="settingsButton" title="設定" style="position: fixed; bottom: 60px; right: 20px; z-index: 1200; width: 50px; height: 50px; background: white; color: black; border: 2px solid black; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: transform 0.2s ease;">⚙️</button>
      <div id="settingsPanel">
        <button id="langToggle" title="Switch Language" style="width:50px; height:50px; border-radius:50%; margin:0 5px; display:flex; align-items:center; justify-content:center;">
          <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/translate.webp" alt="Translate" style="width:35px; height:35px;" />
        </button>
      </div>
    </div>
    <div id="floatingCard"></div>
    <button id="updateCountdown" style="display:none; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 6px 12px; background-color: white; color: #007bff; border: 2px solid #007bff; border-radius: 25px; font-size: 0.8em; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: all 0.3s ease; width: 100px;">60秒後更新</button>
    <div id="centralSettingsPanel">
      <button id="closeCentralSettings">×</button>
      <h2 id="settingsPanelTitle">系統設定</h2>
      
      <div class="settings-group">
              <h3>基本設定</h3>
              <div class="setting-item">
                  <label for="centralRegionSelect" id="regionSelectLabel">地區選擇</label>
                  <select id="centralRegionSelect" style="padding: 5px; border-radius: 5px;">
                      <option value="taipei">台北市</option>
                      <option value="newTaipei">新北市</option>
                      <option value="taoyuan">桃園市</option>
                      <option value="hsinchuCounty">新竹縣</option>
                      <option value="hsinchuCity">新竹市</option>
                      <option value="sciencePark">新竹科學園區</option>
                      <option value="miaoli">苗栗縣</option>
                      <option value="taichung">台中市</option>
                      <option value="chiayi">嘉義市</option>
                      <option value="tainan">臺南市</option>
                      <option value="kaohsiung" selected>高雄市</option>
                      <option value="pingtung">屏東縣</option>
                      <option value="taitung">臺東縣</option>
                  </select>
              </div>
              <div class="setting-item">
                  <label for="centralLocationToggle">位置服務</label>
                  <label class="switch">
                      <input type="checkbox" id="centralLocationToggle">
                      <span class="slider"></span>
                  </label>
              </div>
              <div class="setting-item">
                  <label for="centralDarkModeToggle">深色模式</label>
                  <label class="switch">
                      <input type="checkbox" id="centralDarkModeToggle">
                      <span class="slider"></span>
                  </label>
              </div>
              <div class="setting-item">
                  <label for="centralLangToggle">中文/English</label>
                  <label class="switch">
                      <input type="checkbox" id="centralLangToggle">
                      <span class="slider"></span>
                  </label>
              </div>
          </div>

      <div class="settings-group">
          <h3>外部連結</h3>
          <div class="setting-item">
              <a href="https://github.com/potatosserver/YouBike" target="_blank" class="github-link">
                  <img src="https://potatosserver.github.io/YouBike/icons/html.webp" alt="GitHub Repository" style="width:30px; height:30px;">
                  <span>YouBike Repository</span>
              </a>
          </div>
          <div class="setting-item">
              <a href="https://github.com/potatosserver/YouBike_Python" target="_blank" class="github-link">
                  <img src="https://potatosserver.github.io/YouBike/icons/python.webp" alt="GitHub Repository" style="width:30px; height:30px;">
                  <span>YouBike Python Repository</span>
              </a>
          </div>
      </div>
    </div>
    <script>
      // 新增全域變數
      let leafletMap, markerClusterGroup, tileLayer;
      let userLocation = null;
      let locationMarker = null; // 新增位置標記變數
      let sortingLocked = false;
      let initialLoad = true;
      let locationDenied = false;
      let geolocationErrorMessage = null;
      let dataLoaded = false;
      let hasShownDefaultLocationMessage = false; // 添加新的標記
      const regionCoordinates = {
        taipei: { lat: 25.047924, lng: 121.517081 },
        newTaipei: { lat: 25.0215339197085, lng: 121.4568090197085 },
        taoyuan: { lat: 24.953671, lng: 121.225783 },
        hsinchuCounty: { lat: 24.826917615712, lng: 121.01290295049 },
        hsinchuCity: { lat: 24.801815, lng: 120.971459 },
        sciencePark: { lat: 24.781830, lng: 121.005074 },
        miaoli: { lat: 24.5648599, lng: 120.8185503 },
        taichung: { lat: 24.154712, lng: 120.664265 },
        chiayi: { lat: 23.4797837, lng: 120.4397206 },
        tainan: { lat: 22.99230083082, lng: 120.18509419659 },
        kaohsiung: { lat: 22.631442, lng: 120.301890 },
        pingtung: { lat: 22.683036253664, lng: 120.48790854724 },
        taitung: { lat: 22.755711056126138, lng: 121.15035332587574 }
      };
      let defaultRegion = 'kaohsiung';  // 暫時設定高雄市作為後備預設值
      let defaultLatitude = regionCoordinates.kaohsiung.lat;
      let defaultLongitude = regionCoordinates.kaohsiung.lng;
      const overlay = document.querySelector('.overlay');
      const modal = document.querySelector('.modal');
      const modalText = document.getElementById('modalText');
      const modalButton = document.getElementById('modalButton');
      const resultsDiv = document.getElementById('results');
      const loadingDiv = document.getElementById('loading');
      const keywordInput = document.getElementById('keyword');
      // 新增 clearTextBtn 相關程式碼
      const clearTextBtn = document.getElementById('clearTextBtn');
      keywordInput.addEventListener('input', () => {
          clearTextBtn.style.display = keywordInput.value.trim() ? 'inline-flex' : 'none';
      });
      clearTextBtn.addEventListener('click', () => {
          keywordInput.value = '';
          clearTextBtn.style.display = 'none';
          // 移動地圖到使用者當前定位（使用 userLocation 與 leafletMap）
          if (userLocation && leafletMap) {
            leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, { animate: true });
          }
      });
      const maxResults = 100;
      const defaultSearchArea = "";
      const pinnedStations = new Set(JSON.parse(localStorage.getItem('pinnedStations') || '[]').map(id => String(id)));
      const useLocation = true; // 直接設定為 true
      
      function togglePinStation(stationId, event) {
        event.stopPropagation();

        const id = String(stationId);

        if (pinnedStations.has(id)) {
          pinnedStations.delete(id);
        } else {
          pinnedStations.add(id);
        }

        try {
          localStorage.setItem('pinnedStations', JSON.stringify([...pinnedStations]));
        } catch (e) {
          console.error('Failed to save pinned stations:', e);
        }

        const pinButton = document.querySelector(`.pin-button[data-id="${id}"]`);
        if (pinButton) {
          const isPinned = pinnedStations.has(id);
          pinButton.classList.toggle('pinned', isPinned);
          pinButton.textContent = isPinned ? '★' : '☆';
        }

        updateResultsOrder();
      }
      let mainContentShown = false;
      function showMainContent() {
        if (!mainContentShown) {
          const overlay = document.getElementById("loadingOverlay");
          const mainContent = document.getElementById("mainContent");

          // 添加淡出效果到 loading overlay
          overlay.classList.add('fade-out');

          // 顯示主內容
          mainContent.style.display = "block";
          
          // 強制重繪以觸發動畫
          mainContent.offsetHeight;
          
          // 添加淡入效果到主內容
          mainContent.classList.add('fade-in');

          // 更新倒數計時器顯示
          document.getElementById('updateCountdown').style.display = navigator.onLine ? "block" : "none";
          
          // 在動畫完成後完全移除 overlay
          setTimeout(() => {
            overlay.style.display = "none";
          }, 500);

          mainContentShown = true;
        }
      }
      (function simulateLoadingPercentage() {
        const loadingText = document.getElementById("loadingText");
        let lang = localStorage.getItem("lang") || "zh";
        let prefix = lang === "en" ? "Loading:" : "載入中：";
        let progress = 0;
        let lockedProgress = null;
        loadingTextInterval = setInterval(() => {
          if (!mainContentShown) {
            if (progress < 85) {
              progress++;
              loadingText.textContent = prefix + progress + "%";
            } else {
              if (lockedProgress === null) {
                lockedProgress = 85 + Math.floor(Math.random() * 11);
              }
              loadingText.textContent = prefix + lockedProgress + "%";
            }
          } else {
            clearInterval(loadingTextInterval);
          }
        }, 50);
      })();
      (function showRandomNotice(){
        let lang = localStorage.getItem("lang") || "zh";
        const notices = lang === "en" ? [
              "❌Do not speed or ride in reverse",
              "❌Do not change lanes arbitrarily on sidewalks",
              "❌Do not use your phone while riding",
              "❌Avoid harsh braking while riding",
              "✔️Remember to adjust the seat to a proper height",
              "✔️Ensure that both front and rear lights are working",
              "✔️Remember to get bicycle accident insurance",
              "✔️Take your belongings from the basket"
        ] : [
              "❌勿超速或逆向騎乘",
              "❌勿隨意變換車道在行人道上騎乘",
              "❌勿在車輛行駛中使用手機",
              "❌騎乘中勿緊急煞車",
              "✔️記得調整座墊至適宜高度",
              "✔️確認前後車燈功能正常",
              "✔️記得投保公共自行車傷害險",
              "✔️記得帶走置物籃內的隨身物品"
        ];
        const randomIndex = Math.floor(Math.random() * notices.length);
        document.getElementById('noticeBox').textContent = notices[randomIndex];
      })();

      let youbikeDataCache = null;
      let initializeSearch = null; // 新增全域變數，用於儲存parkingInfo資料

      // IndexedDB 操作函數
      function openYoubikeDB() {
        return new Promise((resolve, reject) => {
          // 請求持久性儲存空間
          if (navigator.storage && navigator.storage.persist) {
            navigator.storage.persist().then(isPersisted => {
              console.log(`持久性儲存權限: ${isPersisted ? '已授權' : '未授權'}`);
            });
          }

          // 修改此處：將版本號從3改為1
          const request = indexedDB.open('YouBikeDB', 1); // 版本改為 1
          
          request.onupgradeneeded = function(event) {
            const db = event.target.result;
            
            // 新增資料庫版本更新的錯誤處理
            db.onerror = function(event) {
              console.error('資料庫更新失敗:', event.target.error);
            };
            
            // 站點資料存儲
            if (!db.objectStoreNames.contains('youbikeData')) {
              const youbikeStore = db.createObjectStore('youbikeData', { keyPath: 'id' });
              youbikeStore.createIndex('timestamp', 'timestamp'); // 新增時間戳記索引
            }
            
            // 地圖圖磚存儲
            if (!db.objectStoreNames.contains('mapTiles')) {
              const tileStore = db.createObjectStore('mapTiles', { keyPath: 'url' });
              tileStore.createIndex('timestamp', 'timestamp');
            }
            
            // 區域資料存儲
            if (!db.objectStoreNames.contains('regionData')) {
              const regionStore = db.createObjectStore('regionData', { keyPath: 'region' });
              regionStore.createIndex('timestamp', 'timestamp'); // 新增時間戳記索引
            }
          };

          request.onsuccess = function(event) {
            const db = event.target.result;
            
            // 新增自動錯誤處理
            db.onerror = function(event) {
              console.error('資料庫操作錯誤:', event.target.error);
            };

            // 定期檢查並備份資料
            setInterval(() => {
              backupData(db);
            }, 24 * 60 * 60 * 1000); // 每24小時執行一次
            
            resolve(db);
          };
          
          request.onerror = function(event) {
            console.error('無法開啟資料庫:', event.target.error);
            reject(event.target.error);
          };
        });
      }

      // 新增資料備份功能
      async function backupData(db) {
        try {
          const tx = db.transaction(['youbikeData', 'regionData'], 'readonly');
          const youbikeStore = tx.objectStore('youbikeData');
          const regionStore = tx.objectStore('regionData');

          // 獲取所有資料
          const youbikeData = await getAllData(youbikeStore);
          const regionData = await getAllData(regionStore);

          // 將資料存入 localStorage 作為備份
          try {
            localStorage.setItem('youbikeData_backup', JSON.stringify(youbikeData));
            localStorage.setItem('regionData_backup', JSON.stringify(regionData));
            localStorage.setItem('backup_timestamp', Date.now().toString());
          } catch (e) {
            console.warn('localStorage 備份失敗，可能是空間不足:', e);
          }
        } catch (error) {
          console.error('資料備份失敗:', error);
        }
      }

      // 輔助函數：從 store 獲取所有資料
      function getAllData(store) {
        return new Promise((resolve, reject) => {
          const data = [];
          store.openCursor().onsuccess = function(event) {
            const cursor = event.target.result;
            if (cursor) {
              data.push(cursor.value);
              cursor.continue();
            } else {
              resolve(data);
            }
          };
        });
      }

      // 修改站點資料儲存函數
      async function saveYoubikeDataToDB(dataArray) {
        const db = await openYoubikeDB();
        const tx = db.transaction('youbikeData', 'readwrite');
        const store = tx.objectStore('youbikeData');
        
        // 清除舊資料
        await store.clear();
        
        // 儲存新資料
        for (const [idx, item] of dataArray.entries()) {
          await store.put({ 
            id: idx,
            value: item,
            timestamp: Date.now()
          });
        }
        
        // 儲存區域資料
        const regionTx = db.transaction('regionData', 'readwrite');
        const regionStore = regionTx.objectStore('regionData');
        await regionStore.put({
          region: defaultRegion,
          coordinates: regionCoordinates[defaultRegion],
          timestamp: Date.now()
        });
        
        return new Promise((resolve, reject) => {
          tx.oncomplete = resolve;
          tx.onerror = reject;
        });
      }

      function getYoubikeDataFromDB() {
        return openYoubikeDB().then(db => {
          return new Promise((resolve, reject) => {
            const tx = db.transaction('youbikeData', 'readonly');
            const store = tx.objectStore('youbikeData');
            const data = [];
            const req = store.openCursor();
            req.onsuccess = function(event) {
              const cursor = event.target.result;
              if (cursor) {
                data.push(cursor.value.value);
                cursor.continue();
              } else {
                resolve(data);
              }
            };
            req.onerror = (e) => reject(e.target.error);
          });
        });
      }

      // 修改 searchYouBike 函數開始部分
      async function searchYouBike(showLoadingIndicator = true, shouldMoveMap = false) {
        if (showLoadingIndicator) showLoading();
        const keyword = keywordInput.value.trim().toLowerCase();
        try {
          if (!youbikeDataCache) {
            if (navigator.onLine) {
              try {
                const youbikeUrl = "https://apis.youbike.com.tw/json/station-min-yb2.json";
                const response = await fetch(youbikeUrl, {
                  headers: {
                    'accept': '*/*',
                    'accept-language': 'zh-TW,zh;q=0.9',
                  }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const youbikeData = await response.json();
                youbikeDataCache = Array.isArray(youbikeData)
                  ? youbikeData.map(item => ({ ...item, lat: parseFloat(item.lat), lng: parseFloat(item.lng) }))
                  : [];
                await saveYoubikeDataToDB(youbikeDataCache);
              } catch (error) {
                console.warn('Failed to fetch online data, trying IndexedDB:', error);
                youbikeDataCache = await getYoubikeDataFromDB();
              }
            } else {
              youbikeDataCache = await getYoubikeDataFromDB();
              showNotification(currentLang === "en" 
                ? "Offline mode: Using cached data" 
                : "離線模式：使用快取資料");
            }
          }
          let youbikeResults = youbikeDataCache;
          if (keyword) {
            youbikeResults = youbikeResults.filter(station => {
              const stationNameTW = station.name_tw ? station.name_tw.toLowerCase() : '';
              const stationAddressTW = station.address_tw ? station.address_tw.toLowerCase() : '';
              const stationNameEN = station.name_en ? station.name_en.toLowerCase() : '';
              const stationAddressEN = station.address_en ? station.address_en.toLowerCase() : '';
              return stationNameTW.includes(keyword) || stationAddressTW.includes(keyword) ||
                     stationNameEN.includes(keyword) || stationAddressEN.includes(keyword);
            });
          }
          youbikeResults = youbikeResults.sort((a, b) => {
            const distA = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              a.lat, a.lng
            );
            const distB = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              b.lat, b.lng
            );
            return distA - distB;
          });
          let limit = keyword ? 50 : 20;
          let usedStations;
          if (!keyword) {
            const pinnedFromLocal = youbikeResults.filter(station => pinnedStations.has(String(station.station_no)));
            const unpinned = youbikeResults.filter(station => !pinnedStations.has(String(station.station_no)));
            pinnedFromLocal.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            unpinned.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedFromLocal, ...unpinned].slice(0, limit);
          } else {
            usedStations = youbikeResults.slice(0, limit);
            const pinnedList = usedStations.filter(station => pinnedStations.has(String(station.station_no)));
            const nonPinnedList = usedStations.filter(station => !pinnedStations.has(String(station.station_no)));
            pinnedList.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            nonPinnedList.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedList, ...nonPinnedList];
          }
          const isOnline = navigator.onLine;
          let vehData = {};
          const stationIds = usedStations.map(station => String(station.station_no));
          if (isOnline) {
            if (initializeSearch) {
              vehData = initializeSearch;
            } else {
              vehData = await queryVehicleData(stationIds);
              initializeSearch = vehData; // 儲存首次呼叫結果，後續直接利用
            }
          }
          const organizedOutput = usedStations.map(site => {
            const info = {
              id: String(site.station_no),
              name: currentLang === "en" ? site.name_en : site.name_tw,
              coords: [site.lat, site.lng],
              district: currentLang === "en" ? site.district_en : site.district_tw,
              address: currentLang === "en" ? site.address_en : site.address_tw
            };
            const vehicle = isOnline ? (Object.entries(vehData).find(([key]) => key === info.id)?.[1] || {}) : {};
            return { station_info: info, vehicle_info: vehicle };
          });
          organizedOutput.forEach(item => {
            const station = item.station_info;
            const vehicle = item.vehicle_info;
            let card = document.querySelector(`.station[data-id="${station.id}"]`);

            const isPinned = pinnedStations.has(String(station.id));
            const pinButtonHtml = `<span
              class="pin-button ${isPinned ? 'pinned' : ''}"
              data-id="${station.id}"
              onclick="togglePinStation('${station.id}', event)"
            >${isPinned ? '★' : '☆'}</span>`;
            const distance = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              station.coords[0],
              station.coords[1]
            );
            const displayDistance = distance < 1 ? Math.round(distance * 1000) + (currentLang === "en" ? " m" : " 公尺")
                                             : distance.toFixed(2) + (currentLang === "en" ? " km" : " 公里");
            const distanceLabel = currentLang === "en" ? "Distance:" : "距離:";
            const addressLabel = currentLang === "en" ? "Address:" : "地址:";
            const slotsLabel = currentLang === "en" ? "Available Slots:" : "可停空位數:";
            const unknownStation = currentLang === "en" ? "Unknown Station" : "未知站點";
            const unknownAddress = currentLang === "en" ? "Unknown Address" : "未知地址";
            const unknownValue = currentLang === "en" ? "Unknown" : "未知";
            const vehicleInfoHtml = isOnline ? `
                      <p>YouBike 2.0: <span class="vehicle_yb2">${vehicle?.available_2_0 !== undefined ? vehicle.available_2_0 : unknownValue}</span></p>
                      <p>YouBike 2.0E: <span class="vehicle_ybe">${vehicle?.available_e !== undefined ? vehicle.available_e : unknownValue}</span></p>
                      <p>${slotsLabel} <span class="vehicle_empty">${vehicle?.empty_spaces !== undefined ? vehicle.empty_spaces : unknownValue}</span></p>
                    ` : '';
            const isDefaultLocation = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
            const distanceHTML = !isDefaultLocation ? `<p class="distance">${distanceLabel} ${displayDistance}</p>` : "";
            const cardContent = `
                      ${pinButtonHtml}
                      <h3>${station.name || unknownStation}</h3>
                      ${distanceHTML}
                      <p>${addressLabel} ${station.address || unknownAddress}</p>
                      ${vehicleInfoHtml}
                  `;
            if (card) {
              card.innerHTML = cardContent;
              card.dataset.lat = station.coords[0];
              card.dataset.lng = station.coords[1];
              card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
            } else {
              card = document.createElement('div');
              card.className = 'station';
              card.dataset.id = station.id;
              card.dataset.lat = station.coords[0];
              card.dataset.lng = station.coords[1];
              card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
              card.innerHTML = cardContent;
              // Add click event listener to move map to station coordinates
              card.addEventListener("click", () => {
                const lat = parseFloat(station.coords[0]);
                const lng = parseFloat(station.coords[1]);
                if (!isNaN(lat) && !isNaN(lng) && leafletMap) {
                  leafletMap.setView([lat, lng], 18, { animate: true, duration: 1 });
                }
              });
              resultsDiv.appendChild(card);
            }
          });
          const validIds = organizedOutput.map(item => item.station_info.id);
          Array.from(resultsDiv.children).forEach(card => {
            if (!validIds.includes(card.dataset.id)) {
              resultsDiv.removeChild(card);
            }
          });          updateResultsOrder();
          await new Promise(resolve => setTimeout(resolve, 0));

          // 找到搜尋結果中距離最近的站點（已按距離排序）
          const stationCards = document.querySelectorAll('.station');
          if (stationCards.length > 0 && shouldMoveMap) {  // 加入 shouldMoveMap 條件檢查
            let nearestStation = null;
            let minDistance = Infinity;
            
            stationCards.forEach(card => {
              const lat = parseFloat(card.dataset.lat);
              const lng = parseFloat(card.dataset.lng);
              const distance = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                lat,
                lng
              );
              
              if (distance < minDistance) {
                minDistance = distance;
                nearestStation = card;
              }
            });

            if (nearestStation) {
              const lat = parseFloat(nearestStation.dataset.lat);
              const lng = parseFloat(nearestStation.dataset.lng);
              if (!isNaN(lat) && !isNaN(lng) && leafletMap) {
                leafletMap.setView([lat, lng], 18, { // 由16變更為18
                  animate: true,
                  duration: 1
                });
              }
            }
          }

          // 更新地圖釘標但不移動視圖
          updateMapMarkers();

          dataLoaded = true;
          if (showLoadingIndicator) {
            showMainContent();
          }
        } catch (error) {
          console.error("Fetch error:", error);
          resultsDiv.innerHTML = `發生錯誤: ${error.message}`;
        } finally {
          if (showLoadingIndicator) hideLoading();
        }
      }
      async function queryVehicleData(stationIds) {
        if (stationIds.length > 60) {
          stationIds = stationIds.slice(0, 60);
        }
        const batchSize = 20;
        const allVehicleData = {};
        const headers = {
          'Accept': '*/*',
          'Content-Type': 'application/json',
          'Origin': 'https://www.youbike.com.tw',
          'Referer': 'https://www.youbike.com.tw/'
        };
        for (let i = 0; i < stationIds.length; i += batchSize) {
          const stationIdBatch = stationIds.slice(i, i + batchSize);
          const body = JSON.stringify({ station_no: stationIdBatch });
          try {
            const response = await fetch('https://apis.youbike.com.tw/tw2/parkingInfo', {
              method: 'POST',
              headers,
              body
            });
            const result = await response.json();
            if (result.retCode === 1 && result.retVal && result.retVal.data) {
              const dataArray = result.retVal.data;
              dataArray.forEach(item => {
                allVehicleData[item.station_no] = {
                  available_2_0: item.available_spaces_detail ? item.available_spaces_detail.yb2 : 0,
                  available_e: item.available_spaces_detail ? item.available_spaces_detail.eyb : 0,
                  empty_spaces: item.empty_spaces || 0
                };
              });
            } else {
              console.error("API 請求失敗:", result.retMsg);
            }
          } catch (e) {
            console.error(e);
          }
        }
        return allVehicleData;
      }
      function updateResultsOrder() {
        const cards = Array.from(document.querySelectorAll(".station"));
        cards.sort((a, b) => {
          const aPinned = pinnedStations.has(a.dataset.id);
          const bPinned = pinnedStations.has(b.dataset.id);
          if (aPinned && !bPinned) return -1;
          if (!aPinned && bPinned) return 1;
          const distanceA = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(a.dataset.lat),
            parseFloat(a.dataset.lng)
          );
          const distanceB = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(b.dataset.lat),
            parseFloat(b.dataset.lng)
          );
          return distanceA - distanceB;
        });
        cards.forEach(card => {
          resultsDiv.appendChild(card);
        });
      }
      function showLoading() {
        loadingDiv.classList.add('show');
      }
      function hideLoading() {
        loadingDiv.classList.remove('show');
      }
      function showNotification(message) {
          // 將提示轉換成右上角顯示的通知
          const notification = document.getElementById('locationNotification');
          notification.textContent = message;
          notification.classList.add('show');
          setTimeout(() => {
            notification.classList.remove('show');
          }, 5000);
      }

      function hideModal() {
          // 不再使用 modal 提示，保留空函式
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }      async function handleGeolocationSuccess(position) {
          const wasDefault = !userLocation || (userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude);
          const isFirstLocation = !locationMarker;  // 使用 locationMarker 判斷是否為第一次定位
          
          userLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };

          if (leafletMap) {
            // 移動地圖至使用者定位（第一次或從預設更新時）
            if (isFirstLocation || wasDefault) {
              leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, { animate: true, duration: 1 });
            }
            if (!locationMarker) {
              // 第一次定位時建立定位標記與脈衝動畫
              locationMarker = L.circleMarker([userLocation.latitude, userLocation.longitude], {
                radius: 10,
                fillColor: '#2196F3',
                fillOpacity: 0.8,
                color: '#ffffff',
                weight: 3,
                pane: 'markerPane'
              }).addTo(leafletMap);

              const pulsingIcon = L.divIcon({
                className: 'pulsing-icon',
                html: '<div class="pulse"></div>',
                iconSize: [20, 20]
              });
              L.marker([userLocation.latitude, userLocation.longitude], {
                icon: pulsingIcon,
                pane: 'markerPane'
              }).addTo(leafletMap);
            } else {
              // 後續只更新定位標記位置
              locationMarker.setLatLng([userLocation.latitude, userLocation.longitude]);
            }
          }
          
          if (wasDefault) {
            await searchYouBike();
            updateResultsOrder();
          } else {
            updateCardDistances();
          }
      }      function handleGeolocationError(error) {
        console.error("Geolocation error:", error);
        locationDenied = true;
        let errorMessage = "";
        let errorType = "";
        let shouldDisableLocationToggle = false; // 新增變數控制是否要關閉開關
        
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = currentLang === "en"
              ? "Location permission denied. The app needs location permission to show nearby stations."
              : "您尚未提供定位權限。需要定位權限才能顯示附近站點。";
            errorType = "permission";
            shouldDisableLocationToggle = true; // 權限被拒絕時關閉開關            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = currentLang === "en"
              ? "Your device doesn't support or has disabled location services. Please check your device settings."
              : "您的裝置不支援或已停用定位服務，請檢查裝置設定。";
                       errorType = "unavailable";
            shouldDisableLocationToggle = true; // 不支援定位時關閉開關
            break;
          case error.TIMEOUT:
            errorMessage = currentLang === "en"
              ? "Location request timed out. Please check your internet connection and try again."
              : "定位請求逾時，請檢查網路連線後再試一次。";
            errorType = "timeout";
            shouldDisableLocationToggle = false; // 定位逾時時保持開關狀態
            break;
          default:
            errorMessage = currentLang === "en"
              ? "Unable to get location. Please check your device settings."
              : "無法取得位置資訊，請檢查裝置設定。";
            errorType = "unknown";
            shouldDisableLocationToggle = false; // 其他錯誤保持開關開啟
        }

        // 更新中央設定面板的定位開關
        const centralLocationToggle = document.getElementById('centralLocationToggle');
        if (shouldDisableLocationToggle && centralLocationToggle) {
          centralLocationToggle.checked = false;
          localStorage.setItem("useLocation", "false");
        }

        // 如果定位開關關閉，移除定位標記
        if (!centralLocationToggle?.checked && locationMarker) {
          locationMarker.remove();
          locationMarker = null;
        }

        // 只在第一次顯示錯誤提示
        if (!hasShownDefaultLocationMessage) {
          const notification = document.getElementById('locationNotification');
          
          // 根據錯誤類型設定不同的背景顏色
          switch (errorType) {
            case "permission":
              notification.style.backgroundColor = "rgba(244, 67, 54, 0.9)"; // 紅色
              break;
            case "unavailable":
              notification.style.backgroundColor = "rgba(255, 152, 0, 0.9)"; // 橙色
              break;
            case "timeout":
              notification.style.backgroundColor = "rgba(255, 193, 7, 0.9)"; // 黃色
              break;
            default:
              notification.style.backgroundColor = "rgba(158, 158, 158, 0.9)"; // 灰色 
          }
          
          notification.textContent = errorMessage;
          notification.classList.add('show');
          
          setTimeout(() => {
            notification.classList.add('hide');
            setTimeout(() => {
              notification.classList.remove('show', 'hide');
              // 重置通知顏色
              notification.style.backgroundColor = "";
            }, 300);
          }, 5000); // 延長顯示時間到 5 秒

          hasShownDefaultLocationMessage = true;
        }

        userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
        if (!shouldDisableLocationToggle) {
          searchYouBike();
        }
      }      function handleGeoUpdateSuccess(position) {
          // 檢查定位開關是否開啟
          const centralLocationToggle = document.getElementById('centralLocationToggle');
          if (!centralLocationToggle?.checked) {
            return; // 如果開關關閉，不處理定位更新
          }
          
          const wasDefault = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
          userLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          
          // 更新位置標記
          if (locationMarker) {
            locationMarker.setLatLng([userLocation.latitude, userLocation.longitude]);
          }
          
          if (wasDefault) {
            searchYouBike().then(() => {
              updateResultsOrder();
            });
          } else {
            updateCardDistances();
          }
      }      function handleGeoUpdateError(error) {
          console.error("Geolocation update error:", error);
          // 新增：如果使用預設座標定位，則不顯示使用先前座標定位提示
          if (userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude) {
            return;
          }
          let errorMessage = currentLang === "en" 
            ? "Unable to update location, continuing with last known position"
            : "無法更新位置，將繼續使用上次的定位";
          
          const notification = document.getElementById('locationNotification');
          notification.textContent = errorMessage;
          notification.classList.add('show');
          
          setTimeout(() => {
            notification.classList.add('hide');
                                        setTimeout(() => {
              notification.classList.remove('show', 'hide');
            }, 300);
          }, 3000);
      }
      let locationIntervalId; // Add this global variable
      async function getLocation() {
        const centralLocationToggle = document.getElementById('centralLocationToggle');
        if (!centralLocationToggle?.checked) {
          if (locationIntervalId) {
            clearInterval(locationIntervalId);
            locationIntervalId = null;
          }
          return;
        }
        
        // 先使用預設位置創建藍點
        if (!locationMarker && leafletMap) {
          locationMarker = L.circleMarker([defaultLatitude, defaultLongitude], {
            radius: 10,
            fillColor: '#2196F3',
            fillOpacity: 0.8,
            color: '#ffffff',
            weight: 3,
            pane: 'markerPane'
          }).addTo(leafletMap);

          // 添加脈衝動畫
          const pulsingIcon = L.divIcon({
            className: 'pulsing-icon',
            html: '<div class="pulse"></div>',
            iconSize: [20, 20]
          });
          
          L.marker([defaultLatitude, defaultLongitude], {
            icon: pulsingIcon,
            pane: 'markerPane'
          }).addTo(leafletMap);
        }

        if (navigator.geolocation) {
          try {
            const positionPromise = new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
              });
            });
            const timeoutPromise = new Promise((_, reject) => {
              setTimeout(() => reject(new Error("TIMEOUT")), 10000);
            });
            const position = await Promise.race([positionPromise, timeoutPromise]);
            handleGeolocationSuccess(position);
          } catch (e) {
            if (e.message === "TIMEOUT") {
              handleGeolocationError({ 
                code: 3, 
                message: currentLang === "en" ? 
                  "Location timeout, using default location" : 
                  "定位超時，使用預設定位"
              });
            } else {
              handleGeolocationError(e);
            }
          }
          
          locationIntervalId = setInterval(() => {
            if (centralLocationToggle?.checked) {
              navigator.geolocation.getCurrentPosition(
                handleGeoUpdateSuccess,
                handleGeoUpdateError,
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
              );
            } else if (locationIntervalId) {
              clearInterval(locationIntervalId);
              locationIntervalId = null;
            }
          }, 10000);
        } else {
          showModal(currentLang === "en" ? 
            "Your browser doesn't support geolocation. Using default location." : 
            "您的瀏覽器不支援地理位置功能。將使用預設座標進行定位。"
          );
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
          hideLoading();
        }
      }
      function updateCardDistances() {
        const cards = document.querySelectorAll('.station');
        cards.forEach(card => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          const newDistance = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            lat, lng
          );
          const distanceEl = card.querySelector('.distance');
          if (distanceEl) {
            if (userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude) {
              distanceEl.textContent = "";
            } else {
              const distanceLabel = currentLang === "en" ? "Distance:" : "距離:";
              const unit = newDistance < 1 ? (currentLang === "en" ? " m" : " 公尺") : (currentLang === "en" ? " km" : " 公里");
              const displayDistance = newDistance < 1 ? Math.round(newDistance * 1000) : newDistance.toFixed(2);
              distanceEl.textContent = distanceLabel + " " + displayDistance + unit;
            }
          }
        });
        updateResultsOrder();
      }
      function updateVehicleData() {
        const stationElements = document.querySelectorAll('.station');
        if (!stationElements.length) return;
        const stationIds = Array.from(stationElements).map(el => el.dataset.id);
        queryVehicleData(stationIds)
          .then(vehicleData => {
            stationElements.forEach(card => {
              const id = card.dataset.id;
              const data = vehicleData[id] || {};
              const yb2El = card.querySelector('.vehicle_yb2');
              const ybeEl = card.querySelector('.vehicle_ybe');
              const emptyEl = card.querySelector('.vehicle_empty');
              if (yb2El) yb2El.textContent = (data.available_2_0 !== undefined ? data.available_2_0 : '未知');
              if (ybeEl) ybeEl.textContent = (data.available_e !== undefined ? data.available_e : '未知');
              if (emptyEl) emptyEl.textContent = (data.empty_spaces !== undefined ? data.empty_spaces : '未知');
            });
            updateResultsOrder();
          })
          .catch(error => {
            console.error("Vehicle data update failed:", error);
          });
      }

      let currentLang = localStorage.getItem("lang") || "zh";

      function updateLanguageTexts() {
        document.title = currentLang === "en" ? "YouBike Site Search : A simple, beautiful site search engine" : "YouBike 站點搜尋 : 一個簡單、美觀、低流量的YouBike站點搜尋器";
        const locationSwitchSpan = document.querySelector('#locationSwitchText');
        if (locationSwitchSpan) {
          locationSwitchSpan.textContent = currentLang === "en" ? "Use Location" : "使用定位";
        }
        const heading = document.getElementById('heading');
               if (heading) {
            heading.textContent = currentLang === "en" ? "YouBike Station Search" : "YouBike  站點搜尋";
        }
               const keywordInput = document.getElementById('keyword');
        if (keywordInput) {
          keywordInput.placeholder = currentLang === "en" ? "Please enter station name or address" : "請輸入站點名稱、地址";
        }
               const updateCountdownBtn = document.getElementById('updateCountdown');
        if (updateCountdownBtn) {
          updateCountdownBtn.textContent = currentLang === "en" ? "60 sec update " : "60秒後更新";
        }
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
          loadingDiv.textContent = currentLang === "en" ? "Loading, please wait..." : "載入中，請稍候...";
        }
        // 新增設定面板文字更新
        const settingsPanelTitle = document.getElementById('settingsPanelTitle');
        if (settingsPanelTitle) {
          settingsPanelTitle.textContent = currentLang === "en" ? "System Settings" : "系統設定";
        }
        const settingGroups = document.querySelectorAll('#centralSettingsPanel .settings-group h3');
        if (settingGroups.length >= 2) {
          settingGroups[0].textContent = currentLang === "en" ? "Basic Settings" : "基本設定";
          settingGroups[1].textContent = currentLang === "en" ? "GitHub Repositories" : "GitHub 儲存庫";
        }
        // 更新基本設定中各選項標籤
        const locationLabel = document.querySelector('#centralSettingsPanel .setting-item label[for="centralLocationToggle"]');
        if (locationLabel) {
          locationLabel.textContent = currentLang === "en" ? "Location Service" : "位置服務";
        }
        const darkModeLabel = document.querySelector('#centralSettingsPanel .setting-item label[for="centralDarkModeToggle"]');
        if (darkModeLabel) {
          darkModeLabel.textContent = currentLang === "en" ? "Dark Mode" : "深色模式";
        }
        const langLabel = document.querySelector('#centralSettingsPanel .setting-item label[for="centralLangToggle"]');
        if (langLabel) {
          langLabel.textContent = currentLang === "en" ? "Chinese/English" : "中文/English";
        }

        // 新增區域選單文字更新
        const regionNames = {
            taipei: { en: "Taipei City", zh: "台北市" },
            newTaipei: { en: "New Taipei City", zh: "新北市" },
            taoyuan: { en: "Taoyuan City", zh: "桃園市" },
            hsinchuCounty: { en: "Hsinchu County", zh: "新竹縣" },
            hsinchuCity: { en: "Hsinchu City", zh: "新竹市" },
            sciencePark: { en: "Hsinchu Science Park", zh: "新竹科學園區" },
            miaoli: { en: "Miaoli County", zh: "苗栗縣" },
            taichung: { en: "Taichung City", zh: "台中市" },
            chiayi: { en: "Chiayi City", zh: "嘉義市" },
            tainan: { en: "Tainan City", zh: "臺南市" },
            kaohsiung: { en: "Kaohsiung City", zh: "高雄市" },
            pingtung: { en: "Pingtung County", zh: "屏東縣" },
            taitung: { en: "Taitung County", zh: "臺東縣" }
        };
        
        const select = document.getElementById('centralRegionSelect');
        const options = select.options;
        
        for (let i = 0; i < options.length; i++) {
            const value = options[i].value;
            options[i].text = regionNames[value][currentLang === "en" ? "en" : "zh"];
        }

        const regionSelectLabel = document.querySelector('label[for="centralRegionSelect"]');
    if (regionSelectLabel) {
        regionSelectLabel.textContent = currentLang === "en" ? "Region" : "地區選擇";
    }
      }
      updateLanguageTexts();

      const langToggle = document.getElementById('langToggle');
      langToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        currentLang = currentLang === "en" ? "zh" : "en";
        localStorage.setItem("lang", currentLang);
        updateLanguageTexts();
        searchYouBike(false);
      });

      // Initialize settings panel and button
      const settingsButton = document.getElementById('settingsButton');
      const centralSettingsPanel = document.getElementById('centralSettingsPanel');
      const closeCentralSettings = document.getElementById('closeCentralSettings');
      
      // Settings button click handler
      settingsButton.addEventListener('click', (event) => {
        event.stopPropagation();
        centralSettingsPanel.style.display = 'block';
        // Push a new state to history when settings panel opens
        history.pushState({ panelOpen: true }, 'Settings', '#settings');
      });
      
      // Close settings panel button click handler
      closeCentralSettings.addEventListener('click', () => {
        centralSettingsPanel.style.display = 'none';
        // If the current history state is for the settings panel, go back
        if (history.state && history.state.panelOpen) {
          history.back();
        }
      });

      // Handle browser back button (Android back gesture)
      window.addEventListener('popstate', (event) => {
        if (event.state && event.state.panelOpen) {
          // If we're going back to a state where the panel was open, close it
          centralSettingsPanel.style.display = 'block'; // Ensure it's visible before hiding
          centralSettingsPanel.style.display = 'none';
        } else if (!centralSettingsPanel.style.display || centralSettingsPanel.style.display === 'none') {
            // If the panel is already closed and we're popping a state, it means we're going back to the main page or further.
            // Do nothing, let the browser handle the navigation.
        } else {
            // If we are on the settings panel and popstate is not related to it, close the panel
            centralSettingsPanel.style.display = 'none';
        }
      });

      // Close settings panel when clicking outside
      document.addEventListener('click', (event) => {
        if (!centralSettingsPanel.contains(event.target) && event.target !== settingsButton) {
            centralSettingsPanel.style.display = 'none';
            // If the panel was open, and we clicked outside, remove the history state for the panel
            if (history.state && history.state.panelOpen) {
                history.back(); // This will trigger popstate, which will then hide the panel.
            }
        }
      });
      
      // Prevent settings panel from closing when clicking inside it
      centralSettingsPanel.addEventListener('click', (event) => {
        event.stopPropagation();
      });

      window.addEventListener('load', async () => {
        try {
          // 檢查是否有網路連線
          if (navigator.onLine) {
            await initMap();
          } else {
            showNotification(currentLang === "en"
              ? "Offline mode: Map features are limited"
              : "離線模式：地圖功能受限");
          }

          // 從 IndexedDB 預先載入資料
          if (!navigator.onLine) {
            try {
              youbikeDataCache = await getYoubikeDataFromDB();
            } catch (error) {
              console.warn('Failed to load cached data:', error);
            }
          }

          // 修改：等待定位作業完成後，再等待卡片搜尋與排序完成，然後再顯示主畫面
          if (centralLocationToggle?.checked) {
            await getLocation();
            await searchYouBike(true, false); // 等待卡片渲染與排序完成
          } else {
            userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
            await searchYouBike(true, false); // 等待卡片渲染與排序完成
          }
          // 卡片搜尋與排序完成後再進入畫面
          showMainContent();
        } catch (error) {
          console.error('Initialization error:', error);
          showNotification(currentLang === "en"
            ? "Error initializing app. Some features may be limited."
            : "初始化應用程式時發生錯誤，部分功能可能受限。");
        }
      });

      keywordInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          searchYouBike(true, true); // 移動地圖
        }
      });


            window.addEventListener('scroll', () => {
        if (settingsPanel.classList.contains('show')) {
            settingsPanel.classList.add('hiding');
           
            setTimeout(() => {
                settingsPanel.classList.remove('show', 'hiding');
            }, 300);
        }
    });
    const searchIcon = document.getElementById('searchIcon');
    searchIcon.addEventListener('click', () => {
      searchYouBike(true, true); // 移動地圖
    });
    // 修改倒數計時器物件
    let countdownTimer = {
        remaining: 60,
        updateButton: document.getElementById('updateCountdown'),
        updateDisplay: function() {
            this.updateButton.textContent = currentLang === "en"
                ? `${this.remaining} sec update `
                : `${this.remaining}秒後更新`;
        },
        reset: function() {
            this.remaining = 60;
            this.updateDisplay();
        },
        update: function() {
            searchYouBike(true, false);  // 明確設定不移動地圖
            this.reset();
        }
    };

    // 修改更新按鈕的事件監聽器
    countdownTimer.updateButton.addEventListener('click', () => {
        countdownTimer.update();  // 使用更新的 update 方法
    });

    // 修改自動更新的計時器
    setInterval(() => {
        countdownTimer.remaining--;
        if (countdownTimer.remaining <= 0) {
            countdownTimer.update();  // 使用更新的 update 方法
        }
        countdownTimer.updateDisplay();
    }, 1000);
      // 修改全域變數
      let allStations = [];
      async function initMap() {
        // 修改：離線模式通知邏輯，不再直接 return
        if (!navigator.onLine) {
          if (!window.offlineNotified) {
            showNotification(currentLang === "en" 
              ? "Offline mode: Using cached map data" 
              : "離線模式：使用快取地圖資料");
            window.offlineNotified = true;
          }
        }
        
        const initialLat = userLocation ? userLocation.latitude : defaultLatitude;
        const initialLng = userLocation ? userLocation.longitude : defaultLongitude;
        
        leafletMap = L.map('map', {
          dragging: true,
          tap: true,
          touchZoom: true,
          doubleClickZoom: true,
          scrollWheelZoom: true,
          zoomControl: true
        }).setView([initialLat, initialLng], 18);

        // 如果有用戶位置，立即創建位置標記
        if (userLocation) {
          locationMarker = L.circleMarker([userLocation.latitude, userLocation.longitude], {
            radius: 10,
            fillColor: '#2196F3',
            fillOpacity: 0.8,
            color: '#ffffff',
            weight: 3,
            pane: 'markerPane'
          }).addTo(leafletMap);
          
          // 添加脈衝動畫效果
          const pulsingIcon = L.divIcon({
            className: 'pulsing-icon',
            html: '<div class="pulse"></div>',
            iconSize: [20, 20]
          });
          
          L.marker([userLocation.latitude, userLocation.longitude], {
            icon: pulsingIcon,
            pane: 'markerPane'
          }).addTo(leafletMap);
        }
        
        // 將 popupPane 的 z-index 設定為最高
        leafletMap.getPanes().popupPane.style.zIndex = "9999";
        
        try {
            tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(leafletMap);
        } catch(err) {
            console.error("Tile layer failed:", err);
            showNotification(currentLang === "en"
                ? "Offline mode: Map tiles unavailable."
                : "離線模式：地圖圖層無法載入。");
        }
        markerClusterGroup = L.markerClusterGroup();
        if (leafletMap && markerClusterGroup) {
          leafletMap.addLayer(markerClusterGroup);
        }
        
        // 新增定位按鈕，顯示於地圖左上角縮放按鈕下方
        let locateControl = L.control({ position: 'topleft' });
        locateControl.onAdd = function(map) {
            let btn = L.DomUtil.create('button', 'leaflet-bar leaflet-control leaflet-control-custom');
            btn.innerHTML = '<i class="material-icons" style="font-size:18px; line-height:30px;">my_location</i>';
            btn.style.width = '30px';
            btn.style.height = '30px';
            btn.style.display = 'flex';  // 新增 flex 布局
            btn.style.alignItems = 'center';  // 垂直置中
            btn.style.justifyContent = 'center';  // 水平置中
            btn.style.padding = '0';  // 移除內邊距
            btn.style.cursor = 'pointer';  // 新增指針樣式
            btn.title = currentLang === "en" ? "Go to my location" : "定位到我目前位置";
            L.DomEvent.on(btn, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);
                if (userLocation) {
                    leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, { animate: true });
                }
            });
            return btn;
        };
        locateControl.addTo(leafletMap);
        
        try {
          // 改成直接使用共用的站點資料，避免重複呼叫 station-min-yb2 API
          let stations = allStations;
          if (!stations || stations.length === 0) {
            stations = await getYoubikeDataFromDB();
          }
          allStations = stations;

          // 清除現有標記
          if (markerClusterGroup) {
            markerClusterGroup.clearLayers();
          }

          // 建立新標記
          stations.forEach(station => {
            const lat = parseFloat(station.lat);
            const lng = parseFloat(station.lng);
            
            if (!isNaN(lat) && !isNaN(lng)) {
              const marker = L.marker([lat, lng]);
              

              marker.on('click', async () => {
                try {
                  let stationInfo = {};
                  if (navigator.onLine) {
                    const vehicleData = await queryVehicleData([station.station_no]);
                    stationInfo = vehicleData[station.station_no] || {};
                  }

                  const content = `
                    <h4>${currentLang === "en" ? station.name_en : station.name_tw}</h4>
                    <p>${currentLang === "en" ? "Address: " : "地址："} ${currentLang === "en" ? station.address_en : station.address_tw}</p>
                    ${navigator.onLine ? `
                      <p>YouBike 2.0: ${stationInfo.available_2_0 !== undefined ? stationInfo.available_2_0 : (currentLang === "en" ? 'Unknown' : '未知')}</p>
                      <p>YouBike 2.0E: ${stationInfo.available_e !== undefined ? stationInfo.available_e : (currentLang === "en" ? 'Unknown' : '未知')}</p>
                      <p>${currentLang === "en" ? "Available Slots: " : "可停空位數："} ${stationInfo.empty_spaces !== undefined ? stationInfo.empty_spaces : (currentLang === "en" ? 'Unknown' : '未知')}</p>
                    ` : `<p>${currentLang === "en" ? "Offline mode: Real-time data unavailable" : "離線模式：無法取得即時資料"}</p>`}
                  `;

                  // 使用地圖內建 Popup 顯示詳細資訊
                  marker.bindPopup(content).openPopup();
                } catch (error) {
                  console.error('取得站點資訊失敗:', error);
                  showNotification(currentLang === "en" ? "Failed to get station information." : "無法取得站點資訊。");
                }
              });
              

              markerClusterGroup.addLayer(marker);
            }
          });
          leafletMap.addLayer(markerClusterGroup);
          
        } catch (error) {
          console.error('初始化地圖失敗:', error);
          showNotification(currentLang === "en" ? "Failed to initialize map." : "初始化地圖失敗。");
        }
      }
      
      // 更新地圖釘標函數現在只需要處理搜尋結果的高亮顯示
      function updateMapMarkers() {
        // 檢查是否離線且地圖元件未初始化
        if (!markerClusterGroup) {
          console.log('Map features are limited in offline mode');
          return;
        }

        try {
          // 重置所有釘標的樣式
          markerClusterGroup.eachLayer(marker => {
            marker.setIcon(L.icon({
              iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41]
            }));
          });
          
          // 高亮顯示搜尋結果的釘標
          const stationCards = document.querySelectorAll('.station');
          stationCards.forEach(card => {
            const lat = parseFloat(card.dataset.lat);
            const lng = parseFloat(card.dataset.lng);
            
            if (markerClusterGroup && typeof markerClusterGroup.eachLayer === 'function') {
              markerClusterGroup.eachLayer(marker => {
                const markerLatLng = marker.getLatLng();
                if (markerLatLng.lat === lat && markerLatLng.lng === lng) {
                  marker.setIcon(L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                  }));
                }
              });
            }
          });
        } catch (error) {
          console.error('Error updating map markers:', error);
          // 不中斷應用程式運行，僅記錄錯誤
        }
      }
      
      // 初始化地圖於頁面載入時
      window.addEventListener('load', () => {

        initMap();
        if (useLocation) {
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike(true, false).then(() => {
            showMainContent();
          });
        }
      });
      
      // 點擊頁面其他區域時，隱藏浮動卡片
      document.addEventListener('click', (e) => {
        const floatingCard = document.getElementById('floatingCard');
        if (!e.target.closest('#floatingCard') && floatingCard.style.display === 'block') {
          floatingCard.style.display = 'none';
        }
      });


      // 重寫拖曳功能
      const mainContent = document.getElementById('mainContent');
      const dragHandle = document.getElementById('dragHandle');
      let startY = 0;
      let startHeight = 0;
      let isDragging = false;

      function onStart(e) {
        const touch = e.touches ? e.touches[0] : e;
        startY = touch.clientY;
        startHeight = mainContent.offsetHeight;
        isDragging = true;
        e.preventDefault();
        mainContent.style.transition = 'none';
      }

      function onMove(e) {
        if (!isDragging) return;
        
        const touch = e.touches ? e.touches[0] : e;
        const currentY = touch.clientY;
        const deltaY = startY - currentY;
        const newHeight = Math.min(
          Math.max(startHeight + deltaY, 200),
          window.innerHeight * 0.85
        );
        
        mainContent.style.height = `${newHeight}px`;
      }

      function onEnd() {
        isDragging = false;
        mainContent.style.transition = 'height 0.2s ease';
      }

      // 滑鼠事件
      dragHandle.addEventListener('mousedown', onStart);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);

      // 觸控事件
      dragHandle.addEventListener('touchstart', onStart, { passive: false });
      document.addEventListener('touchmove', onMove, { passive: true });
      document.addEventListener('touchend', onEnd);
      document.addEventListener('touchcancel', onEnd);

      // 初始化中央設定面板
      document.addEventListener('DOMContentLoaded', () => {
        const centralSettingsPanel = document.getElementById('centralSettingsPanel');
        const centralDarkModeToggle = document.getElementById('centralDarkModeToggle');
        const centralLangToggle = document.getElementById('centralLangToggle');
        const centralLocationToggle = document.getElementById('centralLocationToggle');
        const centralRegionSelect = document.getElementById('centralRegionSelect');

        // 移除重複的預設值設定
        const savedRegion = localStorage.getItem('selectedRegion');
        centralRegionSelect.value = savedRegion || 'kaohsiung';

        // 初始化開關狀態
        centralDarkModeToggle.checked = document.body.classList.contains('dark-mode');
        centralLangToggle.checked = currentLang === "en";
        centralLocationToggle.checked = localStorage.getItem("useLocation") === "true";

        // 深色模式開關
        centralDarkModeToggle.addEventListener('change', () => {
          document.body.classList.toggle('dark-mode');
          const isDark = document.body.classList.contains("dark-mode");
          localStorage.setItem("dark_mode", isDark);
          darkModeToggle.innerHTML = isDark ? '<span style="color:#ffd700; font-size:32px;">☀️</span>' : '🌙';
          if (leafletMap) {
            leafletMap.remove();
          }
          initMap();
          updateMapMarkers();
        });

        // 語言切換開關
        centralLangToggle.addEventListener('change', () => {
          currentLang = currentLang === "en" ? "zh" : "en";
          localStorage.setItem("lang", currentLang);
          updateLanguageTexts();
          searchYouBike(false);
        });

        // 位置服務開關
        centralLocationToggle.addEventListener('change', function() {
            const isChecked = this.checked;
            localStorage.setItem("useLocation", isChecked);
            
            if (isChecked) {
                // 開啟定位後，獲取定位並移動地圖到定位點
                getLocation().then(() => {
                    if (leafletMap && userLocation) {
                        leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, { animate: true });
                    }
                });
            } else {
                if (locationIntervalId) {
                  clearInterval(locationIntervalId);
                  locationIntervalId = null;
                }
                
                // 獲取目前選擇的區域
                const selectedRegion = document.getElementById('centralRegionSelect').value;
                const coords = regionCoordinates[selectedRegion];
                
                // 更新使用者位置到選擇的區域座標
                userLocation = { latitude: coords.lat, longitude: coords.lng };
                
                // 更新藍點位置到預設區域
                if (locationMarker) {
                    locationMarker.setLatLng([coords.lat, coords.lng]);
                } else {
                    locationMarker = L.circleMarker([coords.lat, coords.lng], {
                        radius: 10,
                        fillColor: '#2196F3',
                        fillOpacity: 0.8,
                        color: '#ffffff',
                        weight: 3,
                        pane: 'markerPane'
                    }).addTo(leafletMap);

                    // 添加脈衝動畫效果
                    const pulsingIcon = L.divIcon({
                        className: 'pulsing-icon',
                        html: '<div class="pulse"></div>',
                        iconSize: [20, 20]
                      });
                      
                      L.marker([coords.lat, coords.lng], {
                        icon: pulsingIcon,
                        pane: 'markerPane'
                      }).addTo(leafletMap);
                }
                
                // 移動地圖到選擇的區域
                if (leafletMap) {
                  leafletMap.setView([coords.lat, coords.lng], 18, { animate: true });
                }
                
                searchYouBike();
            }
        });

        // 初始化位置服務開關狀態 - 預設為開啟
        if (localStorage.getItem("useLocation") === null) {
          localStorage.setItem("useLocation", "true");
        }
        centralLocationToggle.checked = localStorage.getItem("useLocation") === "true";

        // 初始化時檢查定位開關狀態
        if (centralLocationToggle.checked) {
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
        }

        // 初始化地區選單
        centralRegionSelect.addEventListener('change', function() {
          const selectedRegion = this.value;
          defaultRegion = selectedRegion;
          localStorage.setItem('selectedRegion', selectedRegion);
          
          const coords = regionCoordinates[selectedRegion];
          
          // 只有在未使用定位服務時才更新預設座標和位置標記
          if (!centralLocationToggle.checked) {
              userLocation = { latitude: coords.lat, longitude: coords.lng };
              
              // 更新或創建位置標記
              if (locationMarker) {
                  locationMarker.setLatLng([coords.lat, coords.lng]);
              } else {
                  locationMarker = L.circleMarker([coords.lat, coords.lng], {
                      radius: 10,
                      fillColor: '#2196F3',
                      fillOpacity: 0.8,
                      color: '#ffffff',
                      weight: 3,
                      pane: 'markerPane'
                  }).addTo(leafletMap);

                  // 添加脈衝動畫效果
                  const pulsingIcon = L.divIcon({
                      className: 'pulsing-icon',
                      html: '<div class="pulse"></div>',
                      iconSize: [20, 20]
                  });
                  
                  L.marker([coords.lat, coords.lng], {
                      icon: pulsingIcon,
                      pane: 'markerPane'
                  }).addTo(leafletMap);
              }
              
              if (leafletMap) {
                  leafletMap.setView([coords.lat, coords.lng], 18, { animate: true });
              }
              searchYouBike();
          }
        });

        // 修改定位服務初始化處理
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    // 找到最近的區域並設為預設值
                    const nearestRegion = findNearestRegion(position.coords.latitude, position.coords.longitude);
                    defaultRegion = nearestRegion;
                    defaultLatitude = regionCoordinates[nearestRegion].lat;
                    defaultLongitude = regionCoordinates[nearestRegion].lng;
                    
                    // 更新本地儲存和選單值
                    localStorage.setItem('selectedRegion', nearestRegion);
                    const centralRegionSelect = document.getElementById('centralRegionSelect');
                    if (centralRegionSelect) {
                      centralRegionSelect.value = nearestRegion;
                    }

                    // 如果沒有使用定位服務,則移動到最近區域
                    if (!centralLocationToggle.checked) {
                      userLocation = { 
                        latitude: regionCoordinates[nearestRegion].lat, 
                        longitude: regionCoordinates[nearestRegion].lng 
                      };
                      if (leafletMap) {
                        leafletMap.setView([userLocation.latitude, userLocation.longitude], 18, { animate: true });
                      }
                      searchYouBike();
                    }
                },
                error => {
                  // 定位失敗時使用儲存的區域,如果沒有則使用高雄市
                  console.warn('Geolocation failed:', error);
                  const savedRegion = localStorage.getItem('selectedRegion') || 'kaohsiung';
                  defaultRegion = savedRegion;
                  defaultLatitude = regionCoordinates[savedRegion].lat;
                  defaultLongitude = regionCoordinates[savedRegion].lng;
                  const centralRegionSelect = document.getElementById('centralRegionSelect');
                  if (centralRegionSelect) {
                    centralRegionSelect.value = savedRegion;
                  }
                }
            );
        }
      });

      // 新增尋找最近區域的輔助函數
      function findNearestRegion(lat, lng) {
          let nearestRegion = 'kaohsiung';
          let minDistance = Infinity;
          
          for (const [region, coords] of Object.entries(regionCoordinates)) {
              const distance = calculateDistance(lat, lng, coords.lat, coords.lng);
              if (distance < minDistance) {
                  minDistance = distance;
                  nearestRegion = region;
              }
          }
          
          return nearestRegion;
      }
    </script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  </body>
</html>